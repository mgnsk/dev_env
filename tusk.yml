options:
  build_uid:
    default: 3000
  build_gid:
    default: 3000

tasks:
  build:
    run:
    - command: podman-compose build

  root:
    usage: Run a root shell.
    run:
    - command: mkdir -p ./mount
    - command: podman-compose -p dev-env run --rm --user root dev-env /bin/bash

  bash:
    usage: Run bash shell as a non-root user.
    run:
    - command: mkdir -p ./mount
    - command: chmod g+s ./mount
    - command: podman unshare setfacl -Rm g:${build_gid}:rwX ./mount
    - command: podman unshare setfacl -Rdm g:${build_gid}:rwx ./mount
    - command: podman-compose -p dev-env run --rm dev-env /bin/bash

  clean:
    run:
    - command: podman rmi mgnsk/dev-env

  ci-build:
    run:
    - command: >
        docker
        build
        --pull
        --build-arg UID=${build_uid}
        --build-arg GID=${build_gid}
        --build-arg USER=${build_user}
        --build-arg GROUP=${build_group}
        -t mgnsk/dev-env:latest
        ./image

  ci-push:
    run:
      command: |
        echo "$DOCKER_TOKEN" | docker login -u mgnsk --password-stdin
        docker push mgnsk/dev-env:latest
