---
options:
  container_uid:
    default: 3000
  container_gid:
    default: 3000
  container_user:
    default: user
  container_group:
    default: user
  upperdir:
    default: ./code

tasks:
  build:
    run:
      - command: >
          podman-compose
          build
          --pull
          --build-arg uid=${container_uid}
          --build-arg gid=${container_gid}
          --build-arg user=${container_user}
          --build-arg group=${container_group}
      - command: podman image prune -f

  bash:
    usage: Run bash shell as a non-root user.
    run:
      - command: >
          go run toolbox.go bash
          --uid ${container_uid}
          --gid ${container_gid}
          --upperdir ${upperdir}
 
  kill:
    run:
      - command: podman pod kill dev-env || true
      - command: podman pod rm dev-env || true
      - task: clean-mounts

  drop-vols:
    run:
      - command: for v in $(podman volume ls | awk 'NR>1 {print $2}' | grep "^dev-env"); do podman volume rm $v; done

  drop-image:
    run:
      - command: podman rmi mgnsk/toolbox || true
      - command: podman rmi mgnsk/toolbox-base || true

  destroy:
    run:
      - task: kill
      - task: drop-vols
      - task: drop-image
