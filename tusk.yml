options:
  uid:
    default: 3000
  gid:
    default: 3000
  dot_url:
    default: https://github.com/mgnsk/dotfiles.git
  dot_commit:
    default: 48377f1ac3852fcc54e029c79c1546995aed1197

tasks:
  build:
    run:
      - set-environment:
          UID: ${uid}
          GID: ${gid}
          DOT_URL: ${dot_url}
          DOT_COMMIT: ${dot_commit}
      - command: podman-compose build

  root:
    usage: Run a root shell.
    run:
      - command: mkdir -p ./mount
      - command: podman-compose -p dev-env run --rm --service-ports --user root dev-env /bin/bash

  bash:
    usage: Run bash shell as a non-root user.
    run:
      - command: mkdir -p ./mount
      # Files created by the container will be writable by the host.
      - command: chmod -R g+rwXs ./mount
      # Existing host files are writable by the container.
      - command: podman unshare setfacl -Rm u:$UID:rwX,g:${gid}:rwX ./mount
      # Files created by the host will be writable by the container.
      - command: podman unshare setfacl -Rdm u:$UID:rwX,g:${gid}:rwx ./mount
      - command: podman-compose -p dev-env run --rm --service-ports dev-env /bin/bash

  clean:
    run:
      - command: podman pod rm dev-env || true
      - command: podman rmi mgnsk/dev-env || true

  ci-build:
    run:
      - command: >
          docker
          build
          --pull
          --build-arg uid=${uid}
          --build-arg gid=${gid}
          --build-arg dot_url=${dot_url}
          --build-arg dot_commit=${dot_commit}
          -t mgnsk/dev-env:latest
          ./image

  ci-push:
    run:
      command: |
        echo "$DOCKER_TOKEN" | docker login -u mgnsk --password-stdin
        docker push mgnsk/dev-env:latest
