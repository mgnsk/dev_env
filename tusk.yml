tasks:
  build:
    run:
    - command: >
        podman-compose build

  bash:
    usage: Run bash shell as a non-root user.
    options:
      uid:
        default:
          command: id -u
      gid:
        default:
          command: id -g
    run:
    # Create the code directory. Files created by the container will be owned by the host group on the host.
    # The container is run with umask 002 so files created by the container are group-writable on the host.
    # Files created by the host must have ACL applied to be writable by the container.
    - command: mkdir -p ./code
    - command: chgrp +${gid} ./code
    - command: chmod g+s ./code
    # Give the container GID 3000 write permissions.
    # Assuming /etc/subgid is set up to map host GID 100000 to container GID 0.
    # Give recursive permissions to existing files.
    - command: podman unshare setfacl -Rm g:3001:rwX ./code
    # Set default permissions for new files.
    - command: podman unshare setfacl -Rdm g:3001:rwX ./code
    - set-environment:
        PODMAN_USERNS: "auto:size=4000"
    - command: podman-compose -p dev-env run --rm dev-env /bin/bash

        #--mount type=volume,source=dev-env_coc-data,target=/homedir/.config/coc
        #--mount type=volume,source=dev-env_nvim-data,target=/homedir/.local/share/nvim
        #--mount type=volume,source=dev-env_ssh-key,target=/homedir/.ssh
        #--mount type=volume,source=dev-env_direnv-allow-cache,target=/homedir/.local/share/direnv
        #--mount type=volume,source=dev-env_tmux-resurrect,target=/homedir/.tmux/resurrect
  clean:
    run:
    - command: podman rmi mgnsk/dev-env

  ci-build:
    run:
    - command: >
        docker
        build
        --pull
        --squash
        --build-arg UID=3000
        --build-arg GID=3000
        --build-arg USER=user
        --build-arg GROUP=user
        -t mgnsk/dev-env:latest
        ./image

  ci-push:
    run:
      command: |
        echo "$DOCKER_TOKEN" | docker login -u mgnsk --password-stdin
        docker push mgnsk/dev-env:latest
