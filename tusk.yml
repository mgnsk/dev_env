options:
  dot_commit:
    default: 26e6993af9c2d0c60071c784cbfb6c031fb8b7a2
  cmd:
    default: podman

tasks:
  build:
    run:
    - command: >
        ${cmd}
        build
        --pull
        --squash
        --build-arg dot_commit=${dot_commit}
        -t mgnsk/dev-env:latest
        ./image

  bash:
    usage: Run a bash shell as host user user.
    description: The user is created and permissions set on entry.
    options:
      uid:
        default:
          command: id -u
      user:
        default:
          command: id -un
      gid:
        default:
          command: id -g
      group:
        default:
          command: id -gn
    run:
    - command: mkdir -p ./code
    - set-environment:
        CMD: ${cmd}
        PODMAN_USERNS: keep-id
    - command: >
        ./create_volumes.sh
        dev-env_ssh-key
        dev-env_coc-data
        dev-env_nvim-data
        dev-env_direnv-allow-cache
    - command: >
        ${cmd}
        run
        --rm
        --cap-drop=ALL
        --cap-add=CAP_SETUID
        --cap-add=CAP_SETGID
        --cap-add=CAP_FOWNER
        --cap-add=CAP_CHOWN
        -it
        --entrypoint /asuser.sh
        --hostname dev-env
        -e UID=${uid}
        -e USER=${user}
        -e GID=${gid}
        -e GROUP=${group}
        -w /code
        --mount type=bind,source="$(pwd)/code",target=/code
        --mount type=volume,source=dev-env_ssh-key,target=/homedir/.ssh
        --mount type=volume,source=dev-env_coc-data,target=/homedir/.config/coc
        --mount type=volume,source=dev-env_nvim-data,target=/homedir/.local/share/nvim
        --mount type=volume,source=dev-env_direnv-allow-cache,target=/homedir/.local/share/direnv
        mgnsk/dev-env
        /bin/bash

  clean:
    run:
    - command: ${cmd} rmi mgnsk/dev-env

  prune-volumes:
    run:
    - command: ${cmd} volume rm dev-env_ssh-key || true
    - command: ${cmd} volume rm dev-env_coc-data || true
    - command: ${cmd} volume rm dev-env_nvim-data || true
    - command: ${cmd} volume rm dev-env_direnv-allow-cache || true

  push:
    run:
      command: |
        echo "$DOCKER_TOKEN" | ${cmd} login -u mgnsk --password-stdin
        ${cmd} push mgnsk/dev-env:latest
