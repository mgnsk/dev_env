tasks:
  build:
    options:
      dot_url:
        default: https://github.com/mgnsk/dotfiles.git
      dot_commit:
        default: 8b969dfb5a856dc5fb0d3c6fd2f9ce5b17151380
    run:
    - command: >
        docker
        build
        --pull
        --build-arg dot_url=${dot_url}
        --build-arg dot_commit=${dot_commit}
        -t mgnsk/dev-env:latest
        ./image

  bash:
    usage: Run a bash shell as host user user.
    description: The user is created and permissions set on entry.
    options:
      uid:
        default:
          command: id -u
      user:
        default:
          command: id -un
      gid:
        default:
          command: id -g
      group:
        default:
          command: id -gn
    run:
    - command: mkdir -p ./code
    - set-environment:
        UID: ${uid}
        USER: ${user}
        GID: ${gid}
        GROUP: ${group}
    - command: docker-compose run --rm --entrypoint /asuser.sh dev-env /bin/bash

  root:
    usage: Run a root shell in the container.
    run:
    - command: mkdir -p ./code
    - command: docker-compose run --rm dev-env /bin/bash

  logs:
    run:
    - command: docker-compose logs -f -t --tail="all"

  clean:
    run:
    - command: docker rmi mgnsk/dev-env

