options:
  container_uid:
    default: 3000
  container_gid:
    default: 3000
  dot_url:
    default: https://github.com/mgnsk/dotfiles.git
  dot_commit:
    default: 0af8c6d7cedc02622816432c82450a6cf28882cd

tasks:
  _make-fuse:
    run:
      - command: mkdir -p code .ssh
      - command: mkdir -p .fuse/code/{lowerdir,workdir,merged}
      - command: mkdir -p .fuse/.ssh/{lowerdir,workdir,merged}
      - command: podman unshare fuse-overlayfs -o uidmapping=0:${container_uid}:1,gidmapping=0:${container_gid}:1,lowerdir=.fuse/code/lowerdir,upperdir=code,workdir=.fuse/code/workdir,timeout=0 .fuse/code/merged
      - command: podman unshare fuse-overlayfs -o uidmapping=0:${container_uid}:1,gidmapping=0:${container_gid}:1,lowerdir=.fuse/.ssh/lowerdir,upperdir=.ssh,workdir=.fuse/.ssh/workdir,timeout=0 .fuse/.ssh/merged

  _clean-fuse:
    run:
      - command: rm -rf .fuse
      - command: find ./code -type c -exec rm -f {} \;
      - command: find ./code -type f -name ".wh..wh..opq" -exec rm {} \;

  _recreate-vols:
    description: Recreate mounts except ssh key.
    run:
      - task: _clean-fuse
      - task: _make-fuse

  build:
    run:
      - command: >
          podman-compose
          build
          --build-arg uid=${container_uid}
          --build-arg gid=${container_gid}
          --build-arg dot_url=${dot_url}
          --build-arg dot_commit=${dot_commit}
      - command: podman image prune -f

  bash:
    usage: Run bash shell as a non-root user.
    run:
      - task: _recreate-vols
      - command: podman-compose -p dev-env run --rm --service-ports dev-env /bin/bash

  drop-vols:
    run:
      - command: podman pod kill dev-env || true
      - task: _clean-fuse
      - command: for v in $(podman volume ls | awk 'NR>1 {print $2}' | grep "^dev-env"); do podman volume rm $v; done

  drop-image:
    run:
      - command: podman pod kill dev-env || true
      - command: podman pod rm dev-env || true
      - command: podman rmi mgnsk/dev-env || true
  
  destroy:
    usage: Destroy all volumes and images. Keeps the ssh keys.
    run:
      - task: drop-vols
      - task: drop-image

  ssh-keygen:
    run:
      - task: _recreate-vols
      - command: podman-compose -p dev-env run --rm dev-env bash -c 'read -p "Enter your email:" email; ssh-keygen -t rsa -b 4096 -C $email -f /homedir/.ssh/id_rsa'

  ci-build:
    run:
      - command: >
          docker
          build
          --pull
          --build-arg uid=${container_uid}
          --build-arg gid=${container_gid}
          --build-arg dot_url=${dot_url}
          --build-arg dot_commit=${dot_commit}
          -t mgnsk/dev-env:latest
          ./image

  ci-push:
    run:
      command: |
        echo "$DOCKER_TOKEN" | docker login -u mgnsk --password-stdin
        docker push mgnsk/dev-env:latest
