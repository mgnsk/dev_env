---
options:
  uid:
    default: 3000
  gid:
    default: 3000
  user:
    default: user
  group:
    default: user
  neovim_commit:
    default: d17e508796be60eefe4a597df62de1fd9e7e1725
  fuse_flags:
    # These flags only apply to the custom bind mount.
    # Container storage options can be configured in ~/.config/containers/storage.conf
    default: noxattrs=1,fsync=0,threaded=0
tasks:
  build:
    usage: Build the toolbox-base and toolbox images.
    run:
      - command: >
          podman-compose
          build
          --pull
          --build-arg uid=${uid}
          --build-arg gid=${gid}
          --build-arg user=${user}
          --build-arg group=${group}
          --build-arg neovim_commit=${neovim_commit}
      - command: podman image prune -f


  bash:
    usage: Run a bash shell as the container UID in user namespace while mounting a shifted view of the filesystem.
    args:
      workspace:
        usage: The workspace directory to run in.
    options:
      tmp:
        private: yes
        default:
          command: podman unshare ./mount.sh ${uid} ${gid} ${fuse_flags} ${workspace}
      starttime:
        default:
          command: date
    run:
      - set-environment:
          WORKSPACE_ROOT: ${tmp}/merged
      - command: podman-compose -p dev-env run --rm --service-ports toolbox /bin/bash
    finally:
      - command: podman unshare ./unmount.sh ${tmp}
      - command: find ${workspace} -newermt "${starttime}" \( -type c -or \( -type f -and -name ".wh..wh..opq" \) \) -delete

  root:
    args:
      workspace:
        usage: The workspace directory to run in.
    options:
      tmp:
        private: yes
        default:
          command: realpath ${workspace}
    run:
      - set-environment:
          WORKSPACE_ROOT: ${tmp}
      - command: podman-compose -p dev-env run --rm --service-ports --user root toolbox /bin/bash

  clean:
    run:
      - command: podman pod kill dev-env || true
      - command: podman pod rm dev-env || true
      - command: for v in $(podman volume ls | awk 'NR>1 {print $2}' | grep "^dev-env"); do podman volume rm $v; done
      - command: for d in .fuse-*; do podman unshare ./unmount.sh $d; done
