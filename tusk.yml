options:
  dot_commit:
    default: 0c43147a46eba9e334e5300c7b7297409f0e7f8a

tasks:
  build:
    options:
      cmd:
        default: podman
    run:
    - command: >
        ${cmd}
        build
        --pull
        --squash
        --build-arg dot_commit=${dot_commit}
        --build-arg UID=3000
        --build-arg GID=3000
        --build-arg USER=user
        --build-arg GROUP=user
        -t mgnsk/dev-env:latest
        ./image

  bash:
    usage: Run bash shell as a non-root user.
    options:
      uid:
        default:
          command: id -u
    run:
    - command: mkdir -p ./code
    # Give the container GID 3000 write permissions to host directory.
    # Assuming /etc/subgid is set up to map host GID 100000 to container GID 0.
    - command: setfacl -R -m g:103000:rwX ./code
    #- command: >
        #./create_volumes.sh
        #dev-env_ssh-key
        #dev-env_coc-data
        #dev-env_nvim-data
        #dev-env_direnv-allow-cache
        #dev-env_tmux-resurrect
    - command: >
        podman
        run
        --rm
        --cap-drop=ALL
        --runtime crun
        --memory 2g
        --userns=auto:uidmapping=${uid}:3000:4000
        --mount type=bind,source="$(pwd)/code",target=/code
        --hostname dev-env
        -it
        mgnsk/dev-env
        /bin/bash
        # TODO volumes not working
        #--mount type=volume,source=dev-env_ssh-key,target=/homedir/.ssh
        #--mount type=volume,source=dev-env_coc-data,target=/homedir/.config/coc
        #--mount type=volume,source=dev-env_nvim-data,target=/homedir/.local/share/nvim
        #--mount type=volume,source=dev-env_direnv-allow-cache,target=/homedir/.local/share/direnv
        #--mount type=volume,source=dev-env_tmux-resurrect,target=/homedir/.tmux/resurrect
  clean:
    run:
    - command: podman rmi mgnsk/dev-env

  prune-volumes:
    run:
    - command: podman volume rm dev-env_ssh-key || true
    - command: podman volume rm dev-env_coc-data || true
    - command: podman volume rm dev-env_nvim-data || true
    - command: podman volume rm dev-env_direnv-allow-cache || true
    - command: podman volume rm dev-env_tmux-resurrect || true

  push:
    usage: Push from docker CI.
    run:
      command: |
        echo "$DOCKER_TOKEN" | docker login -u mgnsk --password-stdin
        docker push mgnsk/dev-env:latest
